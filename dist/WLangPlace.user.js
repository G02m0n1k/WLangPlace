// ==UserScript==
// @name         WLangPlace
// @namespace    https://github.com/G02m0n1k/WLangPlace
// @version      0.43
// @description  Script for using custom translations for Wplace.
// @author       G02m0n1k & KUsHa
// @license      BSD-3-Clause
// @supportURL   https://t.me/WLangPlace
// @homepageURL  https://github.com/G02m0n1k/WLangPlace
// @icon         https://raw.githubusercontent.com/G02m0n1k/WLangPlace/refs/heads/main/assets/icon.png
// @updateURL    https://raw.githubusercontent.com/G02m0n1k/WLangPlace/refs/heads/main/dist/WLangPlace.user.js
// @downloadURL  https://raw.githubusercontent.com/G02m0n1k/WLangPlace/refs/heads/main/dist/WLangPlace.user.js
// @match        https://wplace.live/*
// @grant        GM_xmlhttpRequest
// @connect      raw.githubusercontent.com
// @connect      github.com
// @connect      gitlab.com
// ==/UserScript==

// License ---> https://opensource.org/license/bsd-3-clause

(function(){'use strict';const DEFAULT_CONFIG={translationsUrl: '',encoding: 'utf-8',ignoreSelectors:['script','style','noscript','code','pre','textarea','input','iframe'],translateAttributes:['data-tip','title','alt','placeholder','aria-label','data-content','data-title','data-original-title','data-toggle','data-placement','data-hint','data-tooltip','placeholder'],checkInterval: 500,cacheDuration: 2000,maxRetries: 5,retryDelay: 500,exactMatch: true,dataAttributePriority: true,forceTitleTranslation: true,titleCheckInterval: 2000};let CONFIG={...DEFAULT_CONFIG};let translations=new Map();let patternTranslations=new Map();let isProcessing=false;let retryCount=0;let lastUpdateTime=0;let checkIntervalId=null;let titleCheckIntervalId=null;let attributeObserver=null;let settingsForm=null;const storage={set: function(key,value){try{localStorage.setItem(key,JSON.stringify(value));return true;}catch(e){console.warn('ERROR save in localStorage:',e);return false;}},get: function(key){try{const item=localStorage.getItem(key);return item ? JSON.parse(item): null;}catch(e){console.warn('ERROR read in localStorage:',e);return null;}},delete: function(key){try{localStorage.removeItem(key);return true;}catch(e){console.warn('ERROR delete in localStorage:',e);return false;}}};function init(){console.log('WLangPlace started...');loadUserSettings();function checkAndCreateForm(){const targetElement=document.querySelector('.mt-3.flex.flex-col.gap-2');const existingForm=document.getElementById('wlangplace-settings');if(targetElement&&!existingForm){createSettingsForm();}}checkAndCreateForm();const observer=new MutationObserver((mutations)=>{checkAndCreateForm();});observer.observe(document.body,{childList: true,subtree: true});setInterval(checkAndCreateForm,3000);loadCachedTranslations();startBackgroundChecker();startTitleChecker();observeDynamicContent();setupAttributeInterceptor();setupTitleInterceptor();}function createSettingsForm(){const oldForm=document.getElementById('wlangplace-settings');if(oldForm){oldForm.remove();}const targetElement=document.querySelector('.mt-3.flex.flex-col.gap-2');if(!targetElement)return;const container=document.createElement('div');container.id='wlangplace-settings';container.style.marginTop='20px';container.style.padding='4px';container.style.background='white';container.style.borderRadius='12px';container.style.fontFamily='Arial,sans-serif';settingsForm=document.createElement('form');settingsForm.style.display='inline-flex';settingsForm.style.alignItems='center';settingsForm.style.gap='3px';settingsForm.style.width='100%';const urlInput=document.createElement('input');urlInput.type='url';urlInput.placeholder='URL to RAW with translation';urlInput.title='Enter a link to your RAW file with translation(preferably on GitHub/GitLab)';urlInput.value=CONFIG.translationsUrl;urlInput.style.padding='8px 10px';urlInput.style.width='100%';urlInput.style.boxSizing='border-box';urlInput.style.border='2px solid #E2E7EE';urlInput.style.borderRadius='2rem';urlInput.style.outline='none';urlInput.style.fontSize='14px';const okButton=document.createElement('button');okButton.type='submit';okButton.textContent='âœ”';okButton.className='btn';okButton.style.float='left';okButton.style.padding='8px 16px';okButton.style.border='none';okButton.style.border='2px solid #E2E7EE';settingsForm.appendChild(urlInput);settingsForm.appendChild(okButton);container.appendChild(settingsForm);targetElement.parentNode.insertBefore(container,targetElement);settingsForm.addEventListener('submit',function(e){e.preventDefault();const newUrl=urlInput.value.trim();if(newUrl===''){clearTranslations();alert('Translations are disabled');}else{testUrlAndApply(newUrl);}});}function testUrlAndApply(url){GM_xmlhttpRequest({method: 'GET',url: url,timeout: 5000,onload: function(response){if(response.status===200){CONFIG.translationsUrl=url;saveUserSettings();loadTranslations();alert('Translations included');}else{alert('URL error(status: '+response.status+')');}},onerror: function(error){alert('URL error: '+error);},ontimeout: function(){alert('URL verification timed out');}});}function loadUserSettings(){const userSettings=storage.get('wlangplace_settings');if(userSettings&&userSettings.translationsUrl!==''){CONFIG.translationsUrl=userSettings.translationsUrl;console.log('Load new settings:',CONFIG.translationsUrl);}}function saveUserSettings(){const settings={translationsUrl: CONFIG.translationsUrl,savedAt: Date.now()};storage.set('wlangplace_settings',settings);console.log('Settings saved:',settings);}function clearTranslations(){translations.clear();patternTranslations.clear();storage.delete('translations_cache');CONFIG.translationsUrl='';saveUserSettings();setTimeout(()=>{window.location.reload();},100);}function setupTitleInterceptor(){const originalSetAttribute=Element.prototype.setAttribute;const originalTitleSetter=Object.getOwnPropertyDescriptor(HTMLElement.prototype,'title')?.set;Element.prototype.setAttribute=function(name,value){if(name==='title'&&translations.size>0){const translatedValue=translateText(value);if(translatedValue!==value){value=translatedValue;}}return originalSetAttribute.call(this,name,value);};if(originalTitleSetter){Object.defineProperty(HTMLElement.prototype,'title',{set: function(value){if(translations.size>0){const translatedValue=translateText(value);if(translatedValue!==value){value=translatedValue;}}return originalTitleSetter.call(this,value);},get: Object.getOwnPropertyDescriptor(HTMLElement.prototype,'title').get});}}function startTitleChecker(){if(titleCheckIntervalId){clearInterval(titleCheckIntervalId);}titleCheckIntervalId=setInterval(()=>{if(!isProcessing){forceTitleTranslation();}},CONFIG.titleCheckInterval);}function forceTitleTranslation(){if(translations.size===0&&patternTranslations.size===0)return;const elements=document.querySelectorAll('[title]');let changed=0;elements.forEach(element=>{const originalTitle=element.getAttribute('title');if(originalTitle&&originalTitle.trim()!==''){const translatedTitle=translateText(originalTitle);if(translatedTitle!==originalTitle){element.setAttribute('title',translatedTitle);try{element.title=translatedTitle;}catch(e){}changed++;}}});if(changed>0){console.log(`Update ${changed}title`);}}function setupAttributeInterceptor(){const originalSetAttribute=Element.prototype.setAttribute;Element.prototype.setAttribute=function(name,value){if(CONFIG.translateAttributes.includes(name)&&(translations.size>0||patternTranslations.size>0)){const translatedValue=translateText(value);if(translatedValue!==value){value=translatedValue;}}return originalSetAttribute.call(this,name,value);};}function translateText(text){if(!text||typeof text!=='string')return text;let result=text;if(translations.has(result)){result=translations.get(result);}else{let changed=true;while(changed){changed=false;for(const[_,patternKey]of patternTranslations){let newText=result;switch(patternKey.type){case 'start': if(newText.endsWith(patternKey.pattern)){const dynamicPart=newText.substring(0,newText.length-patternKey.pattern.length);newText=dynamicPart+patternKey.fixedPart;if(newText!==result){result=newText;changed=true;}}break;case 'end': if(newText.startsWith(patternKey.pattern)){const dynamicPart=newText.substring(patternKey.pattern.length);newText=patternKey.fixedPart+dynamicPart;if(newText!==result){result=newText;changed=true;}}break;}if(changed)break;}}}return result;}function startBackgroundChecker(){if(checkIntervalId){clearInterval(checkIntervalId);}checkIntervalId=setInterval(()=>{if(!isProcessing){checkAndApplyTranslations();}},CONFIG.checkInterval);}function checkAndApplyTranslations(){if(CONFIG.translationsUrl===''){translations.clear();patternTranslations.clear();return;}const now=Date.now();if((translations.size===0&&patternTranslations.size===0)||now-lastUpdateTime>CONFIG.cacheDuration){loadTranslations();}else{applyTranslations();applyAttributeTranslations();applyDataTipTranslations();forceTitleTranslation();}}function applyDataTipTranslations(){if(translations.size===0&&patternTranslations.size===0)return;const elements=document.querySelectorAll('[data-tip]');let changed=0;elements.forEach(element=>{const originalValue=element.getAttribute('data-tip');if(originalValue){const translatedValue=translateText(originalValue);if(translatedValue!==originalValue){element.setAttribute('data-tip',translatedValue);changed++;}}});if(changed>0){console.log(`Update ${changed}data-tip`);}}function loadTranslations(){if(isProcessing||CONFIG.translationsUrl==='')return;isProcessing=true;console.log('Downloading translations from:',CONFIG.translationsUrl);GM_xmlhttpRequest({method: 'GET',url: CONFIG.translationsUrl,timeout: 10000,onload: function(response){if(response.status===200){retryCount=0;parseTranslations(response.responseText);cacheTranslations();applyTranslations();applyAttributeTranslations();applyDataTipTranslations();forceTitleTranslation();lastUpdateTime=Date.now();}else{handleLoadError(`HTTP error: ${response.status}`);}isProcessing=false;},onerror: function(error){handleLoadError(`Network error: ${error}`);isProcessing=false;},ontimeout: function(){handleLoadError('Request timeout');isProcessing=false;}});}function parseTranslations(text){const newTranslations=new Map();const newPatternTranslations=new Map();const lines=text.split('\n');lines.forEach((line,index)=>{line=line.trim();if(!line||line.startsWith('#'))return;const match=line.match(/"(.*?)"\s*=\s*"(.*?)"/);if(match&&match.length===3){let original=match[1];let translation=match[2];if(original!==''&&translation!==''){const hasStartPattern=original.startsWith('/#$/');const hasEndPattern=original.endsWith('/#$/');if(hasStartPattern||hasEndPattern){processPatternTranslation(original,translation,newPatternTranslations);}else{newTranslations.set(original,translation);}}}});translations=newTranslations;patternTranslations=newPatternTranslations;console.log(`Downloaded: ${translations.size}exact and ${patternTranslations.size}template translations`);}function processPatternTranslation(original,translation,patternMap){const patternKey={original: original,translation: translation,type: '',pattern: '',fixedPart: ''};if(original.startsWith('/#$/')){const patternText=original.substring(4);patternKey.type='start';patternKey.pattern=patternText;patternKey.fixedPart=translation.substring(4);}else if(original.endsWith('/#$/')){const patternText=original.substring(0,original.length-4);patternKey.type='end';patternKey.pattern=patternText;patternKey.fixedPart=translation.substring(0,translation.length-4);}if(patternKey.type){patternMap.set(original,patternKey);}}function cacheTranslations(){const cacheData={translations: Array.from(translations.entries()),patternTranslations: Array.from(patternTranslations.entries()),timestamp: Date.now()};storage.set('translations_cache',cacheData);}function loadCachedTranslations(){const cacheData=storage.get('translations_cache');if(cacheData){const now=Date.now();if(now-cacheData.timestamp<CONFIG.cacheDuration){translations=new Map(cacheData.translations);patternTranslations=new Map(cacheData.patternTranslations);lastUpdateTime=cacheData.timestamp;console.log(`Loaded from cache: ${translations.size}exact and ${patternTranslations.size}template translations`);return true;}else{console.log('The cache is out of date');storage.delete('translations_cache');}}return false;}function applyTranslations(){if(translations.size===0&&patternTranslations.size===0)return;let changedNodes=0;const walker=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode: function(node){if(node.parentNode&&CONFIG.ignoreSelectors.some(selector=>node.parentNode.closest(selector))){return NodeFilter.FILTER_REJECT;}if(!node.nodeValue||node.nodeValue.trim()===''){return NodeFilter.FILTER_REJECT;}return NodeFilter.FILTER_ACCEPT;}},false);let node;while(node=walker.nextNode()){const originalText=node.nodeValue;const translatedText=translateText(originalText);if(translatedText!==originalText){node.nodeValue=translatedText;changedNodes++;}}if(changedNodes>0){console.log(`Translated ${changedNodes}text nodes`);}}function applyAttributeTranslations(){if(translations.size===0&&patternTranslations.size===0)return;let changedAttributes=0;const selector=CONFIG.translateAttributes.map(attr=>`[${attr}]`).join(',');const elements=document.querySelectorAll(selector);elements.forEach(element=>{CONFIG.translateAttributes.forEach(attr=>{if(element.hasAttribute(attr)){const originalValue=element.getAttribute(attr);if(originalValue){const translatedValue=translateText(originalValue);if(translatedValue!==originalValue){element.setAttribute(attr,translatedValue);changedAttributes++;}}}});});if(changedAttributes>0){console.log(`translated ${changedAttributes}attributes`);}}function observeDynamicContent(){if(attributeObserver){attributeObserver.disconnect();}attributeObserver=new MutationObserver((mutations)=>{let needsUpdate=false;mutations.forEach((mutation)=>{if(mutation.addedNodes.length>0||mutation.type==='characterData'){needsUpdate=true;}if(mutation.type==='attributes'){const attrName=mutation.attributeName;if(CONFIG.translateAttributes.includes(attrName)||attrName==='title'){needsUpdate=true;}}});if(needsUpdate&&!isProcessing){setTimeout(()=>{applyTranslations();applyAttributeTranslations();applyDataTipTranslations();forceTitleTranslation();},100);}});attributeObserver.observe(document.body,{childList: true,subtree: true,characterData: true,attributes: true,attributeFilter:[...CONFIG.translateAttributes,'title']});}function handleLoadError(message){console.error(message);if(retryCount<CONFIG.maxRetries){retryCount++;console.log(`Try again ${retryCount}/${CONFIG.maxRetries}in ${CONFIG.retryDelay/1000}sec`);setTimeout(loadTranslations,CONFIG.retryDelay);}}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);}else{init();}})();